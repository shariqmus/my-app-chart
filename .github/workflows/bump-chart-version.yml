name: Bump Chart Version

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'templates/**'
      - 'values.yaml'
      - 'values.schema.json'
      - 'Chart.yaml'
      - '.github/workflows/bump-chart-version.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'templates/**'
      - 'values.yaml'
      - 'values.schema.json'
      - 'Chart.yaml'

jobs:
  detect-version-bump:
    runs-on: ubuntu-latest
    outputs:
      bump-type: ${{ steps.determine-bump.outputs.bump-type }}
      should-bump: ${{ steps.determine-bump.outputs.should-bump }}
      current-version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version
        id: get-version
        run: |
          VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current chart version: $VERSION"

      - name: Determine version bump type
        id: determine-bump
        run: |
          # Skip if this is a PR or if Chart.yaml was the only file changed
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "bump-type=none" >> $GITHUB_OUTPUT
            echo "should-bump=false" >> $GITHUB_OUTPUT
            echo "Skipping version bump for pull request"
            exit 0
          fi

          # Check if Chart.yaml was the only file changed (to avoid infinite loops)
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -v '^Chart.yaml$' | grep -E '(templates/|values\.yaml|values\.schema\.json)' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "bump-type=none" >> $GITHUB_OUTPUT
            echo "should-bump=false" >> $GITHUB_OUTPUT
            echo "No chart files changed, skipping version bump"
            exit 0
          fi

          # Check for breaking changes (MAJOR bump)
          # Look for removed templates, removed required values, or breaking changes in templates
          BREAKING_CHANGES=$(git diff HEAD~1 HEAD -- templates/ values.yaml | grep -E '^\-.*:' | grep -v '^---' || true)
          REMOVED_TEMPLATES=$(git diff --name-only --diff-filter=D HEAD~1 HEAD templates/ || true)
          
          if [ -n "$REMOVED_TEMPLATES" ] || echo "$BREAKING_CHANGES" | grep -qE '(required|deprecated|removed)'; then
            echo "bump-type=major" >> $GITHUB_OUTPUT
            echo "should-bump=true" >> $GITHUB_OUTPUT
            echo "Detected breaking changes, will bump MAJOR version"
            exit 0
          fi

          # Check for new templates or new features (MINOR bump)
          NEW_TEMPLATES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD templates/ || true)
          NEW_VALUES=$(git diff HEAD~1 HEAD values.yaml | grep -E '^\+.*:' | grep -v '^+++' | grep -v '^version:' || true)
          
          if [ -n "$NEW_TEMPLATES" ] || [ -n "$NEW_VALUES" ]; then
            echo "bump-type=minor" >> $GITHUB_OUTPUT
            echo "should-bump=true" >> $GITHUB_OUTPUT
            echo "Detected new features, will bump MINOR version"
            exit 0
          fi

          # Default to PATCH for any other changes
          echo "bump-type=patch" >> $GITHUB_OUTPUT
          echo "should-bump=true" >> $GITHUB_OUTPUT
          echo "Detected patch-level changes, will bump PATCH version"

  bump-version:
    needs: detect-version-bump
    if: needs.detect-version-bump.outputs.should-bump == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Bump chart version
        id: bump
        run: |
          BUMP_TYPE="${{ needs.detect-version-bump.outputs.bump-type }}"
          CURRENT_VERSION="${{ needs.detect-version-bump.outputs.current-version }}"
          
          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          case "$BUMP_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumping version from $CURRENT_VERSION to $NEW_VERSION ($BUMP_TYPE)"
          
          # Update Chart.yaml
          if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/^version:.*/version: $NEW_VERSION/" Chart.yaml
          else
            sed -i "s/^version:.*/version: $NEW_VERSION/" Chart.yaml
          fi

      - name: Commit and push
        run: |
          git add Chart.yaml
          git commit -m "chore: bump chart version to ${{ steps.bump.outputs.new-version }} [skip ci]" || exit 0
          git push

  validate-version:
    needs: detect-version-bump
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate version format
        run: |
          VERSION="${{ needs.detect-version-bump.outputs.current-version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid version format: $VERSION"
            exit 1
          fi
          echo "Version format is valid: $VERSION"

      - name: Comment on PR
        if: needs.detect-version-bump.outputs.should-bump == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const bumpType = '${{ needs.detect-version-bump.outputs.bump-type }}';
            const currentVersion = '${{ needs.detect-version-bump.outputs.current-version }}';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Chart version will be automatically bumped to ${bumpType} after merge.\n\nCurrent version: \`${currentVersion}\`\nBump type: \`${bumpType}\``
            });

